- extends "smartmin/read.html"
- load smartmin i18n thumbnail

- block pre-content

- block content

  - include 'modals.haml'

  %script{ type:"text/javascript" }
    var contextData = {{ context_data_json|safe }};

  .ng-cloak{ ng-controller:"PartnerController", ng-init:"init()", ng-cloak:"" }
    .page-header.clearfix{ style:"border-bottom: none" }
      .clearfix{ style:"margin-bottom: 10px" }
        .page-header-buttons
          - if can_manage
            .btn-group
              %a.btn.btn-default{ href:"{% url 'cases.partner_update' object.pk %}", tooltip:"Edit Partner" }
                %span.glyphicon.glyphicon-pencil
              - if org_perms.cases.partner_delete
                %a.btn.btn-default{ ng-click:"onDeletePartner()", tooltip:"Delete" }
                  %span.glyphicon.glyphicon-trash

        - if object.logo
          .partner-logo.pull-back
            {% thumbnail object.logo "200x80" format="PNG" as im %}
            %img.logo{ src:"{{ im.url }}", alt:"{{ partner.name }}"}
            {% endthumbnail %}
        %h2
          {{ object.name }}

      .header-details
        - if partner.get_labels
          - for label in partner.get_labels
            %span.label-container
              %span.label.label-success
                {{ label.name }}
              &nbsp;
        - else
          %i
            - trans "No labels"

    <uib-tabset active="active">

      <uib-tab index="0" select="onTabSelect('summary')">
        <uib-tab-heading>
          <i class="glyphicon glyphicon-dashboard"></i> {% trans "Summary" %}
        </uib-tab-heading>
        <br/>
        <div class="row">
          <div class="col-md-4">
            <ul>
              <li>Total replies: <strong>{{ summary.total_replies }}</strong></li>
              <li>Number of open cases: <strong>{{ summary.cases_open }}</strong></li>
              <li>Number of closed cases: <strong>{{ summary.cases_closed }}</strong></li>
            </ul>
          </div>
          <div class="col-md-8">
            <div class="chart chart-replies-by-month"></div>
          </div>
        </div>
      </uib-tab>

      {% if can_view_replies %}
      <uib-tab index="1" select="onTabSelect('replies')">
        <uib-tab-heading>
          <i class="glyphicon glyphicon-comment"></i> {% trans "Replies" %}
        </uib-tab-heading>
        <div class="ng-cloak" ng-controller="PartnerRepliesController" ng-init="init()">
          <div class="tab-controls">
            {% if perms.msgs.replyexport_create or org_perms.msgs.replyexport_create %}
            <div class="pull-away">
              <button class="btn btn-default" type="button" ng-click="onExportSearch()">
                <span class="glyphicon glyphicon-save"></span> {% trans "Export..." %}
              </button>
            </div>
            {% endif %}
          </div>
          <div infinite-scroll="loadOldItems(false)" infinite-scroll-disabled="!isInfiniteScrollEnabled()">
            %table.table.table-striped
              %thead
                %th
                  - trans "Contact"
                %th
                  %span.glyphicon.glyphicon-flag
                %th
                  - trans "Message"
                %th
                  - trans "User"
                %th
                  - trans "Reply"
                %th
                  - trans "On"
                %th
                  - trans "Delay"
              %tbody
                %tr{ ng-repeat:"item in items" }
                  %td{ nowrap:"" }
                    %span.glyphicon.glyphicon-phone>
                    [[ item.contact.uuid | limitTo:6 | uppercase ]]
                  %td
                    %span.glyphicon.glyphicon-flag{ ng-if:"item.reply_to.flagged" }
                  %td
                    %span.label-container{ ng-if:"item.case" }
                      %span.label.label-warning
                        [[ item.case.assignee.name ]]
                      &nbsp;
                    %span.label-container{ ng-repeat:"label in item.reply_to.labels" }
                      %span.label.label-success
                        [[ label.name ]]
                      &nbsp;
                    [[ item.reply_to.text ]]
                  %td
                    %a{ ng-href:"/user/read/[[ item.sender.id ]]/" }><
                      [[ item.sender.name ]]
                  %td
                    [[ item.text ]]
                  %td{ nowrap:"" }
                    [[ item.time | autodate ]]
                  %td
                    <span ng-class="{'time-warning': item.response.warning}">[[ item.response.delay ]]</span>
          </div>

          .loading{ ng-if:"oldItemsLoading" }
          .none{ ng-hide:"oldItemsLoading || items.length > 0" }
            - trans "None"
          .none{ ng-hide:"oldItemsLoading || !hasTooManyItemsToDisplay()" }
            - trans "More items than can be displayed"
        </div>
      </uib-tab>
      {% endif %}

      <uib-tab index="2" select="onTabSelect('users')">
        <uib-tab-heading>
          <i class="glyphicon glyphicon-user"></i> Users
        </uib-tab-heading>
        <div class="tab-controls">
          Total of <strong>[[ users.length ]]</strong> users
            {% if can_manage %}
            <div class="pull-away">
              <a class="btn btn-default" href="{% url 'profiles.user_create_in' object.pk %}">{% trans "New..." %}</a>
            </div>
            {% endif %}
        </div>
        %table.table.table-striped
          %thead
            %th
              - trans "Name"
            %th
              - trans "Role"
            %th
              - trans "Replies (this month)"
            %th
              - trans "Replies (last month)"
            %th
              - trans "Replies (total)"
          %tbody
            %tr{ ng-repeat:"user in users" }
              %td
                %a{ ng-href:"/user/read/[[ user.id ]]/" }><
                  [[ user.name ]]
              %td
                [[ user.role ]]
              %td
                [[ user.replies.this_month ]]
              %td
                [[ user.replies.last_month ]]
              %td
                [[ user.replies.total ]]
        .none{ ng-if:"!users" }
          - trans "None"

      </uib-tab>
    </uib-tabset>


- block extra-script
  {{ block.super }}
  :javascript
    $(function() {
      $('.chart-replies-by-month').highcharts({
        chart: { type: 'column' },
        title: { text: null },
        xAxis: { categories: contextData.replies_by_month[0] },
        yAxis: { min: 0, title: { text: 'Replies' }},
        legend: { enabled: false },
        series: [{ name: 'Replies', data: contextData.replies_by_month[1] }],
        credits: { enabled: false }
      });
    });


- block extra-style
  {{ block.super }}
  :css
    .partner-logo {
      margin: 15px 20px 0 0;
      border: 1px solid #BBB;
    }
    .partner-label {
      margin-left: 1em
    }
    .tab-controls {
      padding: 10px 0;
    }
    .time-warning {
      color: #922
    }
    .chart {
      width: 100%;
      height: 250px;
    }
