- extends "smartmin/read.html"
- load smartmin i18n

- block pre-content

- block content

  - include 'common_dialogs.haml'

  %script{ type:"text/javascript" }
    var contextData = {{ context_data_json|safe }};

  .{ ng-controller:"CaseController", ng-init:"init({{ object.pk }})" }
    .page-header
      .clearfix
        %h2.pull-back
          %span.glyphicon{ ng-class:'{ "glyphicon-folder-close": case.is_closed, "glyphicon-folder-open": !case.is_closed }' }
          &nbsp;
          Case #{{ object.pk }}

        .page-header-buttons
          - if org_perms.cases.case_update
            .btn-group
              %button.btn.btn-default{ type:"button", ng-if:"!case.is_closed", ng-click:"note()" }
                - trans "Add Note"
              %button.btn.btn-default{ type:"button", ng-if:"!case.is_closed", ng-click:"reassign()" }
                - trans "Re-assign"
              %button.btn.btn-default{ type:"button", ng-if:"!case.is_closed", ng-click:"close()" }
                - trans "Close"
              %button.btn.btn-default{ type:"button", ng-if:"case.is_closed", ng-click:"reopen()" }
                - trans "Re-open"

      %ul.case-details
        %li
          %strong><
            - trans "Assignee"
          :
          %a{ ng-href:"/partner/read/[[ case.assignee.id ]]/" }
            [[ case.assignee.name ]]
        %li
          %strong><
            - trans "Status"
          :
          [[ case.is_closed ? "Closed" : "Open" ]]
        %li
          %strong><
            - trans "Labels"
          :
          %span.label-container{ ng-repeat:"label in case.labels" }
            %span.label.label-primary
              [[ label.name ]]
            &nbsp;

    .row
      .col-md-12
        .{ ng-controller:"CaseTimelineController", ng-init:"init()" }
          .timeline-event{ ng-repeat:"event in timeline | reverse", ng-class:'{ "timeline-action": event.is_action, "timeline-incoming": event.is_message_in, "timeline-outgoing": event.is_message_out }' }
            .event-time
              [[ event.time | autodate ]]

            .{ ng-if:"event.is_action" }
              %a{ ng-href:"/user/read/[[ event.item.created_by.id ]]/" }
                [[ event.item.created_by.name ]]

              %span{ ng-if:'event.item.action == "O"' }
                opened this case and assigned it to
                %a{ ng-href:"/partner/read/[[ event.item.assignee.id ]]/" }
                  [[ event.item.assignee.name ]]

              %span{ ng-if:'event.item.action == "N"' }
                added a note

              %span{ ng-if:'event.item.action == "A"' }
                re-assigned this case to
                %a{ ng-href:"/partner/read/[[ event.item.assignee.id ]]/" }
                  [[ event.item.assignee.name ]]

              %span{ ng-if:'event.item.action == "C"' }
                closed this case

              %span{ ng-if:'event.item.action == "R"' }
                re-opened this case

              .action-note{ ng-if:"event.item.note" }
                [[ event.item.note ]]

            .{ ng-if:"event.is_message_in || event.is_message_out" }
              [[ event.item.text ]]


- block extra-style
  {{ block.super }}
  :css
    ul.case-details {
      margin: 0;
      padding: 0;
    }
    ul.case-details li {
      display: inline-block;
      margin: 5px;
      padding: 0;
      list-style: none;
    }
    .timeline-event {
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid transparent;
      border-radius: 4px;
      -webkit-box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
    }
    .timeline-action {
      background-color: #FDEECF;
      border-color: #F0E1C4;
    }
    .timeline-incoming {
      margin-right: 100px;
      background-color: #DFF8FD;
      border-color: #DCF3F5;
    }
    .timeline-outgoing {
      margin-left: 100px;
      background-color: #DDFDDD;
      border-color: #D4F3D4;
    }
    .timeline-event .event-time {
      float: right;
      font-size: 0.7em;
      margin-left: 3px;
      margin-bottom: 3px;
    }
    .timeline-event .action-note {
      padding: 0.5em 0 0 2em;
      font-style: italic;
    }
